---
- name: Deploy Containerized Application to AWS EKS
  hosts: localhost
  connection: local
  gather_facts: false

  # Variables passed from Jenkins: image_tag, ecr_uri, kubeconfig_path
  
  tasks:
    - name: Use kubernetes.core.k8s to apply deployment manifest
      kubernetes.core.k8s:
        state: present
        # Use the kubeconfig file generated by Jenkins' AWS CLI call
        kubeconfig: "{{ kubeconfig_path }}" 
        namespace: default
        # Use the deployment template file
        template: "{{ playbook_dir }}/../k8s/deployment.yml.j2"
        wait: true
        wait_timeout: 600
      vars:
        # Construct the full image URI for the Jinja template
        image_full_uri: "{{ ecr_uri }}:{{ image_tag }}"
